var themer=(function(){var c="/colours.css",d="/jquery-ui-1.9.2.custom.css",b=$("#appCss"),a=$(".coloursCss"),f=$(".jqueryUICss"),e=function(i){var h=(document.location.protocol!="file:"),k=(h?"/css/":"css/")+i,j=k+c,g=k+d;$(document).data("theme",i);$.when($.get(j),$.get(g)).then(function(){if(a.length>0){a.prop("href",j)}else{$("<link />").attr({type:"text/css",rel:"stylesheet","class":"coloursCss",href:j}).insertAfter(b);a=$(".coloursCss")}if(f.length>0){f.prop("href",g)}else{$("<link />").attr({type:"text/css",rel:"stylesheet","class":"jqueryUICss",href:g}).insertBefore(b);f=$(".jqueryUICss")}})};return{setTheme:e}})();(function(){var j=location.search.substring(1),e=j.indexOf("#"),f,b,g,k,d="default",a=d,h,c;if(e>0){j=j.substring(1,e)}f=j.split("&");for(g=0,b=f.length;g<b;++g){k=f[g].split("=");if(k[0]==="theme"){a=k[1];break}}if(a!==d){themer.setTheme(a)}})();Timeline.CancerEventSource=function(a){var b=new Timeline.DefaultEventSource(a);b.loadJSON=Timeline.CancerEventSource.prototype.loadJSON;return b};Timeline.CancerEventSource.prototype.getIconURLForEventType=function(c){var b=c.type,d;console.log("eventType: ",b);switch(b){case"DIAGNOSIS":d="diagnosis_40_40.jpg";break;case"SURGERY":d="surgery_40_40.jpg";break;case"CHEMO":d="chemo_40_40.jpg";break;case"RADIATION":d="radiation_40_40.jpg";break;case"TEST":var a=(c.typeDetails!=null)?c.typeDetails.testType:"default";switch(a){case"CT_SCAN":d="ctscan_40_40.jpg";break;case"MRI":d="mri_40_40.jpg";break;case"ULTRASOUND":d="ultrasound_40_40.jpg";break;default:console.log("Unknown test type: ",a);break}break;default:d="";break}console.log("iconURL: ",d);return d};Timeline.CancerEventSource.prototype.loadJSON=function(m,c){var e=this._getBaseURL(c),b=[];var f;var g;if(m&&m.events){var n=("wikiURL" in m)?m.wikiURL:null;var q=("wikiSection" in m)?m.wikiSection:null;var j=("dateTimeFormat" in m)?m.dateTimeFormat:null;var l=this._events.getUnit().getParser(j);for(var k=0;k<m.events.length;k++){var a=m.events[k];var d=a.isDuration||(a.durationEvent!=null&&!a.durationEvent);var o=this._resolveRelativeURL(a.icon,e);console.log("oldIcon: ",o);var h="/images/"+Timeline.CancerEventSource.prototype.getIconURLForEventType(a);console.log("newIcon: ",h);var p=new Timeline.DefaultEventSource.Event({id:("id" in a)?a.id:undefined,start:l(a.start),end:l(a.end),latestStart:l(a.latestStart),earliestEnd:l(a.earliestEnd),instant:d,text:a.title,description:a.description,image:this._resolveRelativeURL(a.image,e),link:this._resolveRelativeURL(a.link,e),icon:h,color:a.color,textColor:a.textColor,hoverText:a.hoverText,classname:a.classname,tapeImage:a.tapeImage,tapeRepeat:a.tapeRepeat,caption:a.caption,eventID:a.eventID,trackNum:a.trackNum});p._obj=a;p.getProperty=function(i){return this._obj[i]};p.setWikiInfo(n,q);this._events.add(p);b.push(p)}}if(b.length>0){console.log("firing the 'onAddMany' event with: ",b);this._fire("onAddMany",[b])}};function Sandbox(){var b=Array.prototype.slice.call(arguments),f=b.pop(),a=(b[0]&&typeof b[0]==="string")?b:b[0],c;if(!(this instanceof Sandbox)){return new Sandbox(a,f)}if(!a||(a[0]&&a[0]==="*")){a=[];for(c in Sandbox.modules){if(Sandbox.modules.hasOwnProperty(c)){a.push(c)}}}for(c=0;c<a.length;++c){try{Sandbox.modules[a[c]](this)}catch(d){console.log("modules[i]=",a[c]);console.log(d)}}f(this)}Sandbox.prototype={name:"My Application",version:"1.0",getName:function(){return this.name}};var errorMsg="Sandbox is not defined.  Timeline module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.common=function(e){var d=function d(g,h){$(".email",this).remove()},f=function f(){return"<div class='email'><a href='mailto:TallFry@facebook.com'>TallFry@facebook.com</a></div>"};e.initThemer=function b(){var h=$(document).data("theme"),i=$("#themeSelector"),g=$("option[value='"+h+"']",i).index(),g=g>=0?g:0;i.prop("selectedIndex",g).change(function(j){themer.setTheme(this.options[this.selectedIndex].value)})};e.getEmailHTML=f;e.removeEmail=d;e.clipText=function(h,g){console.log("\n\n\n\n\nvalue: ",h,"\n\n\n\n\n");return(h.length>g)?h=h.substring(0,g)+"...":h};e.createCounter=function a(){var g=0;return{nextInt:function(){return ++g},init:function(h){if(typeof h==="number"&&h>0){g=h}}}};e.setupDialogs=function c(g){$(".dialog").dialog(g);$("#designedByDialog").bind("dialogbeforeclose",d);$("#designedByDialog").dialog({open:function(){$("#designedByDialog").append($(f()).prepend("email: "))}});$(".menu").click(function(h){var i=h.target.id;$("#"+i+"Dialog").dialog("open")})};e.getResizer=function(g){var h=null;return function(){console.log("onResize()");if(h==null){h=window.setTimeout(function(){h=null;g.layout()},500)}}};e.doPreFetch=function(){$("<div style='display:none'><img src='/images/bubble-top-left.png'/><img src='/images/bubble-top-right.png'/><img src='/images/bubble-bottom-left.png'/><img src='/images/bubble-bottom-right.png'/><img src='/images/bubble-left.png'/><img src='/images/bubble-right.png'/><img src='/images/bubble-top.png'/><img src='/images/bubble-bottom.png'/><img src='/images/close-button.png'/><img src='/images/bubble-arrow-point-right.png'/><img src='/images/bubble-arrow-point-left.png'/><img src='/images/bubble-arrow-point-up.png'/><img src='/images/bubble-arrow-point-down.png'/></div>").appendTo("head")}};var errorMsg="Sandbox is not defined.  Timeline module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.timeline_view=function(f){var h="#my-timeline",g="events.json",c="",k=new Date(),d=k,i=Object.prototype.hasOwnProperty,o=false,n=function(q){var r=Timeline.ClassicTheme.create(),p=q||{};r.autoWidth=false;r.autoWidthMargin=10;r.event.bubble.width=220;r.event.bubble.height=120;r.ether.backgroundColors=["#E6E6E6","#F7F7F7"];r.timeline_start=p.startProj||k;r.timeline_stop=p.endProj||d;r.event.instant.icon="no-image-40.png";r.event.instant.iconWidth=40;r.event.instant.iconHeight=40;return r},m=function(p){return p&&p.indexOf("://")>0},l=function(p){return p&&p.substr(0,p.indexOf("/",p.indexOf("://")+3))},b=function(p){if(!p){return}if(!m(p)){var r=b(document.location.href);if(p.substr(0,1)=="/"){p=l(r)+p}else{p=r+p}}var q=p.lastIndexOf("/");if(q<0){return""}else{return p.substr(0,q+1)}},e=function(p,q){if(p==null||p==""||m(p)){return p}else{if(p.substr(0,1)=="/"){return l(q)+p}else{return q+p}}},j=function(r,p){var q;r.applyToBands(function(){if(!q){q=this.getEventSource().getEvent(p);return}});if(!q){console.error("Unable to find an event for ID ",p," so cannot center timeline around event specified.");return}return q};centerOnDate=function(q,p){q.getBand(0).setCenterVisibleDate(SimileAjax.DateTime.parseGregorianDateTime(p));return false},centerOnEvent=function(r,p){var q;q=j(r,p);r.applyToBands(function(){this.setCenterVisibleDate(q.getStart())},true)},a=function a(u){var t=u,w={},s,p=0,r=function(x){var y=x.getProperty("typeIndex");if(typeof y!="number"){return true}return !w[y]},v=function(x){return(s===x.getID())?p++:-1},q=function(){t.applyToBands(function(){this.getEventPainter().paint()})};t.applyToBands(function(){var x=this.getEventPainter();x.setFilterMatcher(r);x.setHighlightMatcher(v)});return{show:function(x){w[x]=false;q()},hide:function(x){w[x]=true;q()},highlight:function(x){s=x;q()},unhighlight:function(x){if(x===s){s=null}q()}}},makeTimelineController=function a(u){var t=u,w={},s,p=0,r=function(x){var y=x.getProperty("typeIndex");if(typeof y!="number"){return true}return !w[y]},v=function(x){return(s===x.getID())?p++:-1},q=function(){t.applyToBands(function(){this.getEventPainter().paint()})};t.applyToBands(function(){var x=this.getEventPainter();x.setFilterMatcher(r);x.setHighlightMatcher(v)});return{show:function(x){w[x]=false;q()},hide:function(x){w[x]=true;q()},highlight:function(x){s=x;q()},unhighlight:function(x){if(x===s){s=null}q()}}},enhanceTimelineLibrary=function(){Timeline.EventUtils=$.extend(Timeline.EventUtils,(function(){var p=f.createCounter();return{getNewEventID:function(){var q="e"+p.nextInt()+"_"+new Date().getTime();console.log("assigning eventID: ",q);return q},counterInit:function(q){console.log("initializing counter to: ",q);p.init(q)}}})());Timeline.DefaultEventSource.prototype._getBaseURL=b;Timeline.DefaultEventSource.prototype._resolveRelativeURL=e;Timeline.DefaultEventSource.Event.prototype.fillDescription=function(p){p.innerHTML=(this._description||"").replace(/\\n/g,"<br/>")};Timeline.OriginalEventPainter.prototype._getHighlightColor=function(p,r){var q=r.event.highlightColors;return q[p%(q.length-1)]};Timeline._Band.prototype.addDecorator=function(p){if(!p){console.error("Attempted to add invalid decorator.");return}this._decorators.push(p);p.initialize(this,this._timeline)};Timeline._Impl.prototype.loadJSON=function(s,t){var q=this;var r=function(v,w,u){try{t(v,s)}finally{q.hideLoadingMessage()}};var p=function(u,w,v){console.error("Failed to load json data from ",s,"\n",w);q.hideLoadingMessage()};this.showLoadingMessage();$.ajax({url:s,dataType:"json",success:r,error:p})};Timeline._Impl.prototype.applyToBands=function(w,u){var t=this.getBandCount(),s,q,v,p,r={};if(typeof w!=="function"){console.error("Method not supplied or is not a function, so there is nothing to apply to the bands.");return}if(u){q=this._bandInfos;for(p=0;p<t;++p){v=q[p].syncWith;if(typeof v==="number"){r[p]=true}}}for(p=0;p<t;++p){if(!r[p]){console.log("Applying method to band: ",p);w.apply(this.getBand(p))}else{console.log("Skipping applying method to band",p," cuz it's synched with another band; don't need to apply to EVERY band.");console.trace()}}}},createEventInfoUpdater=function(s){var p=["#diagnosisDetailsTemplate","#surgeryDetailsTemplate","#chemoDetailsTemplate","#radiationDetailsTemplate","#immunoDetailsTemplate","#testDetailsTemplate"],t=$(s).get(),q=function(w){var v,u;console.log("addEvents called!");if(!w){console.error("addEvents called, but with invalid events argument: ",w);return}for(v=0,u=w.length;v<u;++v){r(w[v])}console.log("done adding events.")},r=function(v){var w,u;console.log("adding event: ",v);w=v.getProperty("typeIndex");u=p[w]||"#notImplementedTemplate";console.log("applying template: ",u," to event: ",v," and appending it to container: ",t[w]);$(u).tmpl($.extend(v,{getDebugJSON:function(x){return(x!==undefined)?JSON.stringify(x):JSON.stringify(this)},getProperty:function(y){var x=this._obj.typeDetails,z=x&&x[y];if(typeof z==="boolean"){z=z?"YES":"NO"}else{if(z==="true"){z="YES"}else{if(z==="false"){z="NO"}}}return z},hasProperty:function(y){var x=this._obj.typeDetails;return x&&i.call(x,y)}})).appendTo(t[w])};console.log("\n\n\n eventTypeContentContainers: ",t,"\n\n\n");console.dir(t);return{addEvent:r,addEvents:q,onAddOne:q,onAddMany:q}},updateEventTypeVis=function(p){var q=$(".eventTypeContent").index($(p).parents(".eventTypeContent"));if(p&&p.value=="show"){updater.show(q)}else{updater.hide(q)}};makeVisibilityUpdater=function(q){return function p(r){var s=$(".eventTypeContent").index($(r).parents(".eventTypeContent"));if(r&&r.value=="show"){q.show(s)}else{q.hide(s)}}};f.createTimeline=function(t){var p=t||{},z,x,q=p.eventSource||c,r=p.startProj||k,u=p.endProj||d,s=p.theme||n({startProj:r,endProj:u}),y=p.bandInfos,v=p.timelineContainerID||h,w=p.eventDataURL||g;if(!o){enhanceTimelineLibrary();o=true}y[0].theme=y[1].theme=s;z=Timeline.create($(v)[0],y);return z};f.getDefaultTheme=n;f.isAbsoluteURL=m;f.getDomain=l;f.centerOnDate=centerOnDate;f.centerOnEvent=centerOnEvent;f.makeUpdater=a;f.createEventInfoUpdater=createEventInfoUpdater;f.makeTimelineController=makeTimelineController;f.makeVisibilityUpdater=makeVisibilityUpdater;f.updateEventTypeVis=updateEventTypeVis};var errorMsg="Sandbox is not defined.  Timeline module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.chapter_viewer=function(d){var i="chapter-index-",c=(function(){var k=d.createCounter();return{getNewChapterID:function(){var l="c"+k.nextInt()+"_"+new Date().getTime();console.log("assigning chapterID: ",l);return l},counterInit:function(l){console.log("initializing counter to: ",l);k.init(l)}}})(),f=function f(k,l){console.log("\n\n\nchapters: ",k,"\n\n\n");try{$("#addChapterTabTemplate").tmpl({chapters:k,offset:l,clip:d.clipText}).appendTo("#patientNotesNav");$("#addChapterTextTemplate").tmpl({chapters:k,offset:l}).appendTo("#patientNotes ul")}catch(m){console.error(m)}},b=function(l){return function k(o){var n="highlightedChapter",p,m;m=l.data(n)||{};console.log("$highlightedChapter = ",m);p=$(o.target).data("chapterIndex");console.log("chapterIndex = ",p);if(m.length>0){m.addClass("hidden")}m=$(".ui-state-highlight."+i+p);m.removeClass("hidden");l.data(n,m)}},h=function(l,k,m){if(l){l.addDecorator(new Timeline.SpanHighlightDecorator({startDate:k.start,endDate:k.end,cssClass:"ui-state-highlight hidden "+m,opacity:30}))}},e=function(m,n){var l=new Date((new Date(m.start).getTime()+new Date(m.end).getTime())/2),k=$(this.nextSibling);console.log("centerDate = ",l);$(this).data("centerDate",l).data("chapterIndex",n).data("chapterID",m.id).button()},a=function a(l){return function k(p,n,o){var q=n?n.getBand(0):null,m=p.chapters,o=o||0;f(m,o);$("#patientNotesNav input:radio").slice(o).each(function(s,u){var r=m[s],t=s+o,v=i+t;e.call(this,r,t);h(q,r,v)});if(n){n.paint()}g(l,n);console.log("done loading chapters")}},g=function(m,o){var l=b(m),k=function(){var p,q;q=$(this);p=$(this).data("centerDate");console.log("centering on date...",p);d.centerOnDate(o,p);$("#patientNotes .chapter").hide();$("#"+this.id+"_text").show()},n=function(p){console.log("inside onClickHandler, this: ",this);k.call(this,p);l.call(this,p)};m.on("click","input:radio",n).find("input:radio").first().click()},j=function j(k){return{addChapters:a(k)}};$.extend(d,{ChaptersUtil:c,renderChapters:f,makeChaptersUpdater:j})};var errorMsg="Sandbox is not defined.  Timeline module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.timeline_edit=function(d){var c=false,b=Object.prototype.hasOwnProperty,a=function(){if(c){console.log("exiting 'enhanceTimelineLibrary' without doing anything; 'enhanceTimelineLibrary' has already been called in this module.");return}SimileAjax.EventIndex.prototype.remove=function(e){this._events.remove(e);delete this._idToEvent[e.getID()];this._indexed=false};Timeline.DefaultEventSource.prototype.convertToTimelineEvent=function(i,g,k){var l,f,e,g=g||"events.json",k=k||{},j=this._getBaseURL(g),h=("dateTimeFormat" in k)?k.dateTimeFormat:"Gregorian",e=this._events.getUnit().getParser(h);f=i.isDuration||(i.durationEvent!=null&&!i.durationEvent);l=new Timeline.DefaultEventSource.Event({id:("id" in i)?i.id:undefined,start:e(i.start),end:e(i.end),latestStart:e(i.latestStart),earliestEnd:e(i.earliestEnd),instant:f,text:i.title,description:i.description,image:this._resolveRelativeURL(i.image,j),link:this._resolveRelativeURL(i.link,j),icon:this._resolveRelativeURL(i.icon,j),color:i.color,textColor:i.textColor,hoverText:i.hoverText,classname:i.classname,tapeImage:i.tapeImage,tapeRepeat:i.tapeRepeat,caption:i.caption,eventID:i.eventID,trackNum:i.trackNum});l._obj=i;l.getProperty=function(m){return this._obj[m]};return l};Timeline.DefaultEventSource.prototype.deleteEvent=function(f){var e=this._events.getEvent(f);this._events.remove(e);this._fire("onDelete",[e])};Timeline.DefaultEventSource.prototype.updateEvent=function(f){var e,g,i,h;parseDateTimeFunction=this._events.getUnit().getParser("Gregorian");e=this.convertToTimelineEvent(f);e._obj=f;e.getProperty=function(j){return this._obj[j]};console.log("updatedEvent is now: ",e);i=e.getID();g=this._events.getEvent(i);if(!g){console.error("Unable to find an existing event with ID: ",i);return}this._events.remove(g);this._events.add(e);h={before:g,after:e};console.log("onUpdateChangeObj.. ");console.dir(h);this._fire("onUpdate",[h])};Timeline._Impl.prototype.augmentListeners=(function(){var f=function(){console.log("onDelete called on band: ",this.band);this.band._onDelete()},e=function(){console.log("onUpdate called on band: ",this.band);this.band._onUpdate()};return function(){this.applyToBands(function(){var g;if(this._eventListener){g=this._eventListener}else{g={};this._eventSource.addListener(g)}g.band=this;g.onDelete=f;g.onUpdate=e})}})();Timeline._Band.prototype._onDelete=function(){this._paintEvents()};Timeline._Band.prototype._onUpdate=function(){this._paintEvents()};c=true};a()};var errorMsg="Sandbox is not defined.  Timeline module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.chapter_editor=function(c){var b=c.HIGHLIGHTED_INDEX_BASE_CLASSNAME;c.addChapters=function a(g,e,f){var h=e?e.getBand(0):null,d=g.chapters,f=f||0;c.renderChapters(d,f);$("#patientNotesNav input:radio").slice(f).each(function(l,n){var k=d[l],j=new Date((new Date(k.start).getTime()+new Date(k.end).getTime())/2),m=l+f,o=b+m,i=$(this.nextSibling);console.log("centerDate = ",j);$(this).data("centerDate",j).data("chapterIndex",m).button().click(function(q){var p,r;r=$(this);p=$(this).data("centerDate");console.log("centering on date...",p);c.centerOnDate(e,p);$("#patientNotes .chapter").hide();$("#"+this.id+"_text").show()});if(h){h.addDecorator(new Timeline.SpanHighlightDecorator({startDate:k.start,endDate:k.end,cssClass:"ui-state-highlight hidden "+o,opacity:30}))}});if(e){e.paint()}console.log("done loading chapters")}};var errorMsg="Sandbox is not defined.  DAO module will not be loaded.";if(!Sandbox){console.error(errorMsg);throw {name:"NoSandboxError",message:errorMsg}}if(!Sandbox.modules){Sandbox.modules={}}Sandbox.modules.dao=function(c){var a=[{title:"Help",start:"January 4, 2013",end:"January 17, 2013",typeIndex:-1,type:"CHAPTER",typeDetails:{text:"This is where 'chapters' of your story show up.  Click the 'Add Chapter' button to start telling your story."}}],b=(function(){var f=function(g){return function(){console.log(g,"(",arguments,")")}},d=function(){for(method in b){if(b.hasOwnProperty(method)){b[method]()}}},e=function(g){var h={};$.each(g,function(j,i){h[i]=f(i)});h.testDummyDAO=d;return h};return e(["updateEvent","addEvent","deleteEvent","loadEvent","addChapter","deleteChapter","initAutoCompletes"])})();$.extend(b,{getEvents:function(){return{dateTimeFormat:"Gregorian",events:[]}},getChapters:function(){return{chapters:a}}});c.getDAO=function(){return b}};Sandbox(["timeline_view","timeline_edit","common","chapter_viewer","dao"],function(m){var f="longDate",b="li",l=m.ChaptersUtil,q={debug:true,errorLabelContainer:"#theAbyss .hidden",wrapper:b,focusInvalid:false,highlight:function(L,J,K){console.log("highlight called");$(L).addClass(J).removeClass(K);$(L.form).find("label[for="+L.id+"]").addClass(J);console.log("done highlighting")},unhighlight:function(L,J,K){console.log("unhighlight called");$(L).removeClass(J).addClass(K);$(L.form).find("label[for="+L.id+"]").removeClass(J);console.log("done unhighlighting")}},A=function(J){return function(L,N){var K,M;if(N.length===0){K=this.successList[0].name;console.log("going to remove ",K," from errors");J.clearError(K)}else{M=this.invalid;if(N.length>1){J.setErrors(L)}else{$.each(L,function(O,P){J.setError(O,P)})}}this.defaultShowErrors()}},c,n,F=m.getDAO(),x,B=new Timeline.CancerEventSource(),j="json/demo_events_images_prefixes.json",r="json/demo_chapters.json",y=function(){var J=SimileAjax.DateTime.parseGregorianDateTime("Sep 1 1898 00:08:00 GMT-0600"),O=SimileAjax.DateTime.parseGregorianDateTime("Nov 27 2112 00:00:00 GMT-0600"),N=m.getDefaultTheme(J,O),L=Timeline.CompactEventPainter,M={iconLabelGap:5,labelRightMargin:20,iconWidth:40,iconHeight:40,stackConcurrentPreciseInstantEvents:{limit:5,moreMessageTemplate:"%0 More Events",icon:"no-image-40.png",iconWidth:40,iconHeight:40}},K=[Timeline.createBandInfo({eventSource:B,eventPainter:L,eventPainterParams:M,date:"Nov 28 2006 00:00:00 GMT-0600",width:"85%",intervalUnit:Timeline.DateTime.MONTH,intervalPixels:100,theme:N}),Timeline.createBandInfo({eventSource:B,layout:"overview",date:"Nov 28 2006 00:00:00 GMT-0600",width:"15%",intervalUnit:Timeline.DateTime.YEAR,intervalPixels:200,theme:N})];K[1].syncWith=0;K[1].highlight=true;K[1].decorators=[new Timeline.SpanHighlightDecorator({startDate:J,endDate:O,inFront:false,color:"#FFC080",opacity:30,theme:N})];c=m.createTimeline({bandInfos:K,eventSource:B,startProj:J,endProj:O,eventDataURL:j});n=m.makeUpdater(c)},h=(function(J){return function(K){return K&&dateFormat(K,J)}})(f),G=function(K,J){return K&&J&&dateFormat(K,J)},I=function(J){var M={start:null,end:null,title:null,description:null,pDescription:null,icon:null,type:null,typeIndex:null},K={},L;L=k(J);for(key in L){if(L[key]==="UNKNOWN"){delete L[key]}else{if(key in M){K[key]=L[key];delete L[key]}}}if(!$.isEmptyObject(L)){K.typeDetails=L}return K},k=function(J){var K={};if(J){$("input[type='text'], input[type='hidden'], select, textarea",J).each(function(){K[this.name]=this.value});$("input[type='checkbox']",J).each(function(){K[this.name]=this.checked?"YES":"NO"});K.start=h(K.start);if(typeof K.end==="string"){K.end=$.trim(K.end);if(K.end.length>0){K.end=h(K.end)}else{delete K.end}}}return K},a=function(J){$("#editEventDiv").find("input, select, textarea").not("[type='button']").each(function(){this.value=J.getProperty(this.name)||""})},w=function(J){var K={dateTimeFormat:"Gregorian"},L,M;L=I(J);console.log("eventData",L);K.events=[L];console.log("eventsJSON",K);B.loadJSON(K,j);c.getBand(0).setCenterVisibleDate(SimileAjax.DateTime.parseGregorianDateTime(L.start));J.reset();$.Watermark.ShowAll()},u=function(J){var L,M,K;M=$("#editEventForm");L=I(M);console.log("eventData",L);B.updateEvent(L);toggleAddEdit("add")},i=function(J){var L,K;if(confirm("Are you sure you want to delete this event?")){$eventNode=$(J.target).parents(".event");K=$eventNode[0].id;console.log("deleteing event with ID: ",K);B.deleteEvent(K);$eventNode.remove();F.deleteEvent(K)}},p=function(S,N){var Q="Just a couple of things for you to correct",L="Looking good!",J={},R=S,P="valid",K=function(U,T){return"<"+N+" name='"+U+"'>"+T+"</"+N+">"},O=function(T){return $(R+" "+N+"[name='"+T+"']")},M=function(){if(P==="valid"&&!$.isEmptyObject(J)){P="invalid";$(R).parent().find(".invalid").show().end().find(".valid").hide().end().parent().find(".ui-dialog-title").text(Q)}else{if(P==="invalid"&&$.isEmptyObject(J)){P="valid";$(R).parent().find(".valid").show().end().find(".invalid").hide().end().parent().find(".ui-dialog-title").text(L)}}};$(S).parent().parent().find(".ui-dialog-title").text(L);return{setError:function(T,W){var U=O(T),V;J[T]=W;if(U.length>0){U.html(W)}else{$(R).prepend(K(T,W))}M()},setErrors:function(T){var U=[];$.extend(J,T);$.each(J,function(V,W){U.push(K(V,W))});$(R).html(U.join(""));M()},clearError:function(T){delete J[T];O(T).remove();M()},}},o=(function t(P){var K="#patientNotesNav",J="#patientNotesContainer",Q=K+" input[type='radio']",O="newChapterTabTitle",N,M=this,L="#errorsDialog .errors";getChapterButtons=function(){return $(Q)},getCurrentChapterBtn=function(){return getChapterButtons().filter(":checked")},getCurrentChapterID=function(){var R=getCurrentChapterBtn();return R.length>0?currentBtn.prop("id"):""},getChapterCount=function(){return getChapterButtons().length};getChapterTextIDFromButtonID=function(R){return"#"+R+"_text"},getNextButton=function(R){return R.next().next()},getPrevButton=function(R){return R.prev().prev()},deleteChapter=function(U){var Y=$(K),X=$(J),T,S,W,R;U.preventDefault();S=getCurrentChapterBtn();if(S.length<=0){console.error("User is trying to delete a chapter, but none is selected.");return}W=S.prop("id");if(W.length<=0){console.error("User is trying to delete a chapter, but none is selected.");return}console.log("\n\n\n\n currentChapterID: ",W);var V=S.data("chapterID");console.log('$chapterSelectorButton.data("chapterID"): ',S.data("chapterID"),"\n\n\n\n ");if(confirm("Are you sure you want to delete this chapter?")){T=$(getChapterTextIDFromButtonID(W),X);R=getNextButton(S);if(R.length<=0){R=getPrevButton(S)}S.hide().button("destroy").next().remove().end().remove();T.remove();if(R.length>0){R.click()}else{$(".deleteEventTrigger",N).hide()}F.deleteChapter(V)}},createChapter=function(R){var T={},W,U,S=getChapterButtons(),V=(S&&S.length)||0;W=I(R);W.id=l.getNewChapterID();console.log("chapter data: ",W);T.chapters=[W];console.log("chaptersJSON",T);x.addChapters(T,c,V);R.reset();$("#newChapterTabTitle").val(null);$.Watermark.ShowAll();if($(".addEventFormLink",N).not(":hidden").length>0){$(".deleteEventTrigger",N).show()}getChapterButtons().last().click();F.addChapter(W)},enableAddingChapters=function(){var X="#patientNotesContainer .msgBox",U=$.extend({},q,{errorContainer:X,messages:{title:"Every chapter has to have a title",start:"Every chapter has to have a beginning.. (start date)",end:"Every chapter has to have an end. (end date) ",description:"Every chapter needs to tell a story!  (description)"},showErrors:A(p(L,b))}),W=$(J),V=function(){$("#modifyChaptersControlsTemplate").tmpl().appendTo("#patientNotesHeader");N=$(".modifyChaptersControls");$("#addEventFormTemplate").tmpl({eventType:["Chapter","Chapter","CHAPTER"]}).appendTo("#patientNotes");$("#addNewChapterTabTemplate").tmpl({tabTitleID:O}).css("display","none").prependTo("#patientNotesNav")},T=function(){var Y=$(this);U.submitHandler=function(Z){M.createChapter(Z)};Y.validate(U)},R=function(Y){var Z;Y.preventDefault();Z=$(".addEventForm",W);Z.prev().slideUp();Z.slideDown();$(".addEventFormLink, .deleteEventTrigger",N).hide();$(".cancelButton",N).show();$("#l_"+O).show()},S=function(Y){var aa=$(this),Z;Z=$(".addEventForm",W);Z.prev().slideDown();Z.slideUp();$(X).hide();$(".cancelButton",N).hide();$(".addEventFormLink, .deleteEventTrigger",N).show();$("#l_"+O).hide()};V();$("form").each(T);$("#patientNotesContainer").on("click","a.errorsDialogLink",function(Y){Y.preventDefault();$("#errorsDialog").dialog("open")});$modifyChaptersControls=$(".modifyChaptersControls");$(".addEventFormLink",$modifyChaptersControls).button().click(R);$(".cancelButton",$modifyChaptersControls).button().click(S);$(".deleteEventTrigger",$modifyChaptersControls).button().click(deleteChapter)};return{deleteChapter:deleteChapter,createChapter:createChapter,init:enableAddingChapters}})(),e=function(J){toggleAddEdit("add")},C=function(){var L=$.extend({},q,{submitHandler:w,messages:{title:"Every medical event has to have a title",start:"Every medical event has to have a beginning.. (start date)",description:"This medical event needs to include a description!  (description)"}}),P={suffix:"_top"},O=[["Diagnosis","Diagnosis","DIAGNOSIS"],["Surgery","Surgery","SURGERY"],["Chemo","Chemotherapy","CHEMO"],["Radiation","Radiation","RADIATION"],["Immuno","Cell Therapy","IMMUNO"],["Test","Test","TEST"]],K=["#eventInfoTabs-diagnosis > .eventTypeVisibilityToggle","#eventInfoTabs-surgery > .eventTypeVisibilityToggle","#eventInfoTabs-chemotherapy > .eventTypeVisibilityToggle","#eventInfoTabs-radiation > .eventTypeVisibilityToggle","#eventInfoTabs-immunotherapy > .eventTypeVisibilityToggle","#eventInfoTabs-test > .eventTypeVisibilityToggle"],M=function(U,Y){var T=$(K[U]),X=T.parent(),R,S=Y[0],V=".eventTypeContent."+S+" .msgBox",W="#errorsDialog"+S,Q=W+" .errors";P.eventType=Y;$("#addEventFormControlsTemplate").tmpl(P).appendTo(T);$("#addEventFormTemplate").tmpl(P).appendTo(T);R=$.extend({errorContainer:V,showErrors:A(p(Q,b))},L);$("#errorsDialogTemplate").tmpl(P).appendTo(X);T.find("form").validate(R);X.on("click","a.errorsDialogLink",function(Z){Z.preventDefault();$(W).dialog("open")})},J=function(Q){var R=$(this);Q.preventDefault();$(".addEventForm",R.parent().parent()).slideDown();R.hide().next().show()},N=function(){var Q=$(this);$(".addEventForm",Q.parent().parent()).slideUp();Q.hide().prev().show()};$.each(O,M);$(".addEventFormLink").not(".Chapter").button().click(J);$(".cancelButton").not(".Chapter").button().click(N)},E=function(){$.validator.setDefaults(q);$.validator.addMethod("name",function J(L,K,M){return this.optional(K)||/[A-Za-z\u00C0-\u1FFF\u2800-\uFFFD\.]*/.test(L)},"Please enter a name.  (e.g. 'Dr. John Smith III')");$.validator.addClassRules("maxLength-10",{maxlength:10})},D=function(){$("input[name='title']").not(".Chapter").Watermark("Please enter a name for this event").end().filter(".Chapter").Watermark("Please enter a title for this chapter");$("input[type='text'][name!='title'][name!='start'][name!='end'][id!='newChapterTabTitle']").Watermark("(optional)");$("#newChapterTabTitle").Watermark("Tab Title")},v=function(K){var J=function(){$("#ui-datepicker-div").css("zIndex","")};$.datepicker.setDefaults(K);$("input[name='start'], input[name='end']").each(function(){$(this).after('<span class="datePicker" style="float: right;"></span>').datepicker().on("click focus",J).next().on("click focus",J)})},d=function(K){var J;K.preventDefault();J=this.href||"";if(J.indexOf("/")>=0){J=J.substring(J.lastIndexOf("/")+1)}m.centerOnEvent(c,J);n.highlight(J)},g=function s(L,K,J){return function(N){var M=$(N.target);if(!M.hasClass(L)){M=M.parents("."+L)[0]}$("."+K,M).css("display",J)}},z=g("event","eventControls","inline-block"),H=g("event","eventControls","none");$(function(){m.initThemer();$(".tabs").tabs();B.addListener(m.createEventInfoUpdater(".eventTypeContent ul"));y();c.augmentListeners();$.when(F.getEvents()).then(function(M){var L;console.log("events data loaded: ",M);$(window).resize(m.getResizer(c));B.loadJSON(M,"/");c.layout();try{L=M.events.length}catch(N){console.warn("attempting to access data.events.length caused exception; setting numChapters to 0");L=0}Timeline.EventUtils.counterInit(L);B.addListener(F)});$.when(F.getChapters()).then(function(L){var N;console.log("chapters data loaded: ",L);x=m.makeChaptersUpdater($("#patientNotesNav")),x.addChapters(L,c);try{N=L.chapters.length}catch(M){console.warn("attempting to access data.chapters.length caused exception; setting numChapters to 0");N=0}l.counterInit(N)});$("#eventInfoBox").on("click",".eventTitle a",d).on("mouseenter",".event",z).on("mouseleave",".event",H).on("click",".eventTypeContent .deleteEventTrigger",i);$("#patientNotes").on("click",".deleteEventTrigger",deleteChapter);E();C();$(window).resize(m.getResizer(c));var J=m.makeVisibilityUpdater(m.makeUpdater(c));$("#eventInfoTabs input:radio").button().click(function(){J.call(this)});c.layout();enableAddingChapters();m.setupDialogs({autoOpen:false,width:550,resizable:false});F.initAutoCompletes();v({altField:$(this).prevAll(".date")[0],altFormat:"MM d, yy",showOn:"both",buttonImage:"/images/calendar.gif",buttonImageOnly:true,changeMonth:true,changeYear:true});$(".addEvent").click(function K(){$.Watermark.HideAll()});$("#ui-datepicker-div").css("zIndex","");$("form.Chapter #newEventTitle").on("keyup",function(){var L=12;$("#newChapterTabTitle").val(m.clipText(this.value,L))});m.doPreFetch();$("#deleteAccountButton").on("click",F.deleteMyAccount)})});(function(){if(window.isUIDisabled){console.log("UI is disabled.");$("body").off("click",disableUI);console.log("UI is now enabled.")}else{console.log("UI is not disabled.")}})();