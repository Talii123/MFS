
        eventIDGenerator = (function (aUser, aSeed) {
            var SEPARATOR_CHAR = "_"
                seed = aSeed || new Date().getTime(),
                user = aUser || "anonUser",
                count = 0,
                lastID = "",

                makeID = function () {
                    ++count;
                    lastID = user + SEPARATOR_CHAR + seed + SEPARATOR_CHAR + count;
                    return lastID;
                },
                getLastID = function () {
                    return lastID;
                };

            return {
                "makeID"        :   makeID,
                "getLastID"     :   getLastID
            };
        })(user, new Date().getTime()),
        /*var singleDate = {
            "onDate"  :   {
                "required"  :   true,
                "date"      :   true
            }            
        };
        var dateRange = {
            "startDate" :   {
                "required"  :   true,
                "date"      :   true
            },
            "endDate"  :    {
                "required"  :   false,
                "date"      :   true,
                "dateRange" :   [".startDate", ".endDate"]
            }
        };

        var eventTypeDefs = {
            "Diagnosis" :   $.extend({}, singleDate),
            "Surgery"   :   $.extend({
                "surgeon"   :  {
                    "name"  : true
                }
            }, singleDate),
            "Chemo"     :   $.extend({
                "oncologist"    : {
                    "name"  :   true
                }
            }, dateRange),
            "Immuno"    :   $.extend({}, dateRange),
            "Test"      :   $.extend({}, singleDate)
        }


        $(".addEventForm").each(function(index, $value) {
            if ($value.hasClass("Diagnosis")) {

            }
            else if ($value.hasClass("Surgery")) {

            }
            else if ($value.hasClass("Chemo")) {

            }
            else if ($value.hasClass("Immuno")) {

            }
            else
        })*/


        enableAddingEvents = function() {        
            var formTmplConfig = {
                    suffix: "_top" 
                    //intoDOM: appendToFunc,
                },
                eventTypes = [
                    ["Diagnosis", "Diagnosis"],
                    ["Surgery", "Surgery"],
                    ["Chemo", "Chemotherapy"],
                    ["Radiation", "Radiation"],
                    ["Immuno", "Cell Therapy"],
                    ["Test", "Test"]
                ],
                locations = [
                    "#eventInfoTabs-diagnosis > .eventTypeVisibilityToggle",
                    "#eventInfoTabs-surgery > .eventTypeVisibilityToggle",
                    "#eventInfoTabs-chemotherapy > .eventTypeVisibilityToggle",
                    "#eventInfoTabs-radiation > .eventTypeVisibilityToggle",
                    "#eventInfoTabs-immunotherapy > .eventTypeVisibilityToggle",
                    "#eventInfoTabs-test > .eventTypeVisibilityToggle"
                ];    
            /*prependToFunc = function(toPrepend, toLocation) {
                toPrepend.prependTo(toLocation);
            }
            appendToFunc = function(toAppend, toLocation) {
                toAppend.appendTo(toLocation);
            }*/

            $.each(eventTypes, function(index, value) {
                formTmplConfig.eventType = value;
                $("#addEventFormTemplate").tmpl(formTmplConfig).appendTo(locations[index]);            
            });


            //$("#addEventFormTemplate").tmpl({eventType: ["Chapter", "Chapter"]}).appendTo("#patientNotesHeader");

            $("form").each(function() {
                $(this).validate({
                    "submitHandler": addEvent
                });
            });

            $(".addEventFormLink").button().click(function($event) {
                var $this = $(this);
                $event.preventDefault();


                $( ".addEventForm", $this.parent().parent() ).slideDown();
                $this.hide().next().show();

                /*$(this).hide();
                $(this).nextAll(".cancelButton").show();*/
            });

            $(".cancelButton").button().click(function() {
                var $this = $(this);

                $(".addEventForm", $this.parent().parent() ).slideUp();
                $this.hide().prev().show();
            });

            //$(".addEvent").click(addEvent);
            $(".addEvent").click(function beforeValidate() {
                $.Watermark.HideAll();
            });
        },


                /*$("#addEventFormTemplate").tmpl(formTmplConfig).appendTo(); 
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: }).appendTo();
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: }).appendTo();
        //$("#addEventFormTemplate").tmpl({suffix: "_top", eventType: }).appendTo();
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: }).appendTo();
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: }).appendTo();*/

                /*var singleDate = {
            "onDate"  :   {
                "required"  :   true,
                "date"      :   true
            }            
        };
        var dateRange = {
            "startDate" :   {
                "required"  :   true,
                "date"      :   true
            },
            "endDate"  :    {
                "required"  :   false,
                "date"      :   true,
                "dateRange" :   [".startDate", ".endDate"]
            }
        };

        var eventTypeDefs = {
            "Diagnosis" :   $.extend({}, singleDate),
            "Surgery"   :   $.extend({
                "surgeon"   :  {
                    "name"  : true
                }
            }, singleDate),
            "Chemo"     :   $.extend({
                "oncologist"    : {
                    "name"  :   true
                }
            }, dateRange),
            "Immuno"    :   $.extend({}, dateRange),
            "Test"      :   $.extend({}, singleDate)
        }


        $(".addEventForm").each(function(index, $value) {
            if ($value.hasClass("Diagnosis")) {

            }
            else if ($value.hasClass("Surgery")) {

            }
            else if ($value.hasClass("Chemo")) {

            }
            else if ($value.hasClass("Immuno")) {

            }
            else
        })*/
        

        <script id="dateRangeInputTemplate" type="text/x-jquery-tmpl">
                Started: <input name="newEventStart" class="date started" /><br/>
                Ended: <input class="date ended" /><br/>
        </script>

        <script id="singleDateInputTemplate" type="text/x-jquery-tmpl">
                Performed: <input class="date performed" />
                <br/>

            {{if $data.getProperty("duration")}}
                Duration: <span class="duration">${$data.getProperty("duration")}</span>
                <br/>
            {{/if}}
        </script> 


                    {{if $data.dateType == 'range'}}
                        {{tmpl "#dateRangeInputTemplate"}}
                    {{else}}
                        {{tmpl "#singleDateInputTemplate"}}
                    {{/if}}



                    <!--<label for="newEventTitle{{= suffix}}">Title </label><input id="newEventTitle{{= suffix}}" name="title" type="text" /><br/>
                    <label for="newEventStart{{= suffix}}">Start </label><input id="newEventStart{{= suffix}}" name="start" type="text" /><br/>
                    -->	



                    
        <script id="addSurgeryEventFormTemplate" type="text/x-jquery-tmpl">
            {{tmpl({eventType: ["Surgery", "Surgery"]}) "#addEventFormControlsTemplate"}}
            <!--<li >-->

            <form class="addEventForm" style="display: none">
                <fieldset>
                    <legend>Add Surgery</legend>

                    <h3>
                        <input id="newEventTitle{{= suffix}}" name="title" type="text" value="Title" />
                    </h3>

                    <div class="newEventContent">
                        <input type="hidden" id="newEventType" name="type" value="surgery" />
                        
                        <!--<label for="newEventTitle{{= suffix}}">Title </label><input id="newEventTitle{{=" name="title" type="text" /><br/>-->

                        {{tmpl "#singleDateInputTemplate"}}
                        {{tmpl "#addSurgeryFormDetailsTemplate"}}
                        {{tmpl "#commonEventDataInputTemplate"}}

                        <br/>
                        <input id="addSurgeryEvent" type="button" value="Add Surgery"/><br/>
                    </div>
                </fieldset>
            </form>
            <!--</li>-->
        </script>


            /*prependToFunc = function(toPrepend, toLocation) {
                toPrepend.prependTo(toLocation);
            }
            appendToFunc = function(toAppend, toLocation) {
                toAppend.appendTo(toLocation);
            }*/


        /*
        //$("#addEventFormControlsTemplate").tmpl().appendTo("#eventInfoTabs-surgery > .eventTypeVisibilityToggle");
        //$("#addSurgeryEventFormTemplate").tmpl({suffix: "_top", dateType: "range"}).prependTo("#eventInfoTabs-surgery > ul");
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Diagnosis", "Diagnosis"]}).appendTo("#eventInfoTabs-diagnosis > .eventTypeVisibilityToggle"); 
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Surgery", "Surgery"]}).appendTo("#eventInfoTabs-surgery > .eventTypeVisibilityToggle");
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Chemo", "Chemotherapy"]}).appendTo("#eventInfoTabs-chemotherapy > .eventTypeVisibilityToggle");
        //$("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Radiation", "Radiation"]}).appendTo("#eventInfoTabs-radiation > .eventTypeVisibilityToggle");
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Immuno", "Cell Therapy"]}).appendTo("#eventInfoTabs-immunotherapy > .eventTypeVisibilityToggle");
        $("#addEventFormTemplate").tmpl({suffix: "_top", eventType: ["Test", "Test"]}).appendTo("#eventInfoTabs-test > .eventTypeVisibilityToggle");

        //$("#addEventFormTemplate").tmpl({eventType: ["Chapter", "Chapter"]}).appendTo("#patientNotesHeader");
        $("form").each(function() {
            $(this).validate({
                "submitHandler": addEvent
            });
        });
*/



            /*oldShowDatePickerFunc = $.datepicker._showDatepicker;
            $.datepicker._showDatepicker = function(input) {
                oldShowDatePickerFunc.call(this, input);

              /*  $("#ui-datepicker-div").css("zIndex", "");
            }*/




        /*showEventControls = function showEventControls($event) {
            //console.log("mouse entered!");

            $event = $($event.target);
            if (!$event.hasClass("event")) {
                $event = $event.parents(".event");
            }
            $(".eventControls", $event).css("display", "inline-block");
        },

        hideEventControls = function hideEventControls($event) {
            //console.log("mouse left!");

            $event = $($event.target);
            if (!$event.hasClass("event")) {
                $event = $event.parents(".event");
            }

            $(".eventControls", $event).hide();
        };*/



                /*showControls = function showControls($UIevent, containerClass, controlsClass) {
            controlsToggle($UIevent, containerClass, controlsClass, "inline-block");
        },

        hideControls = function hideControls($UIevent, containerClass, controlsClass) {
            controlsToggle($UIevent, containerClass, controlsClass, "none");
        },        

        showChapterControls = function showChapterControls($UIevent) {
            showControls($UIevent, "chapter", "chapterControls");
        },  

        hideChapterControls = function hideChapterControls($UIevent) {
            hideControls($UIevent, "chapter", "chapterControls");
        },   

        showEventControls = function showEventControls($UIevent) {
            showControls($UIevent, "event", "eventControls");
        },

        hideEventControls = function hideEventControls($UIevent) {
            hideControls($UIevent, "event", "eventControls");
        };*/


CONTAINER_CLASS = "chapter",
                CONTAINER_CLASS_SELECTOR = "." + CONTAINER_CLASS,
                
                        $eventNode = $(this); //$($eventObj.target).parents(".event");
                //eventID = $eventNode[0].id;
                if (!$eventNode.hasClass(CONTAINER_CLASS)) {
                    $chapterTextDiv = $eventNode.parents(CONTAINER_CLASS_SELECTOR);
                }
                else {
                    // shouldn't happen, should it?
                    $chapterTextDiv = $eventNode;
                }

                if ($eventNode.length <= 0) {
                    console.error("Unable to delete chapter; cannot locate chapter node to delete.");
                    return;
                }
                
                chapterTextDivID = $chapterTextDiv.prop("id");
                chapterID = chapterTextDivID.substring(0, chapterTextDivID.indexOf("_text"));

                $chapterSelectorButton = $("#"+chapterID, $patientNotesNav);





                            
                            $.each(errorMap, function(errorField, msg) {
                                var errorID = "#errorMsg_"+errorField,
                                    $existingError = $(errorID);
                                if ($existingError) {
                                    $existingError.show();
                                }
                                else {
                                    errorsHTML.push("<div id='"+errorID+"'>"+msg)
                                }
                            });      



                                                /* this is stupid
                    ERROR_WRAPPER_START_TAG = ERROR_WRAPPER_EL.length > 0 ? 
                        "<" + ERROR_WRAPPER_EL + ">" : "",
                    ERROR_WRAPPER_END_TAG = ERROR_WRAPPER_EL.length > 0 ? 
                        "</" + ERROR_WRAPPER_EL + ">" : "",
                    

                    getErrorMsgStartTag(attrs)*/
